<div class="flex justify-content-between mb-5">
    <div>
        <div>
            <p-selectButton [options]="rpnumbers" [multiple]="true" [(ngModel)]="rpSelected" optionLabel="RP_Number"
                optionValue="idrpnumber" (onChange)="changeRP(); enviarRPs();"></p-selectButton>
            <div class="mt-2 font-bold" *ngIf="dateRanges">
                {{dateRanges.Reporting_period_start | date: 'dd/MM/yyyy': 'UTC'}} - {{dateRanges.Reporting_period_end |
                date: 'dd/MM/yyyy': 'UTC'}}
            </div>
        </div>
    </div>
    <div>
        <p-button label="Download by accounts" (onClick)="exportFTToExcel()" styleClass="p-button-outlined" class="m-1"
            icon="pi pi-file-excel"></p-button>
        <p-button label="Provisional MXN Ledger" (onClick)="exportProvisionalReport()"
            [pTooltip]="messageProvisionalReport" tooltipPosition="top" styleClass="p-button-outlined" class="m-1"
            icon="pi pi-file-excel"></p-button>
    </div>
</div>
<p-table [loading]="loading" paginatorDropdownAppendTo="body" dataKey="id" [value]="FinancialTrackerData" [rows]="5"
    [showCurrentPageReport]="true" [tableStyle]="{ 'min-width': '50rem' }"
    currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries" [lazy]="true"
    [rowsPerPageOptions]="[10, 25, 50]">
    <ng-template pTemplate="header">
        <tr>
            <th width="27.5%">Account Type</th>
            <th width="12.5%" class="text-right">ERPA Approved</th>
            <th width="12.5%" class="text-center">Approved by assembly</th>
            <th width="12.5%" class="text-right">Planned</th>
            <th width="12.5%" class="text-right">Actual<i class="pi pi-calendar-times ml-2" 
                    [pTooltip]="LastUpdatePaid"></i></th>
            <th width="12.5%" class="text-right">Provisional<i class="pi pi-calendar-times ml-2" 
                    [pTooltip]="LastUpdateProvisional"></i></th>
        </tr>
    </ng-template>
    <ng-template pTemplate="body" let-yourRowVaraible let-expanded="expanded">
        <tr>
            <td><strong>{{yourRowVaraible.Name}}</strong></td>
            <td class="text-right"><strong>{{yourRowVaraible.Approved | currency}} USD</strong></td>
            <td class="text-right"><strong>{{yourRowVaraible.Assembly | currency}} USD</strong></td>
            <td class="text-right"><strong>{{yourRowVaraible.Planned | currency}} USD</strong></td>
            <td class="text-right"><strong>{{yourRowVaraible.Paid | currency}} USD</strong></td>
            <td class="text-right"><strong>{{yourRowVaraible.Provisional | currency}} MXN</strong></td>
            <td>
                <button type="button" pButton pRipple [pRowToggler]="yourRowVaraible"
                    class="p-button-text p-button-rounded p-button-plain"
                    [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></button>
            </td>
        </tr>
    </ng-template>
    <ng-template pTemplate="rowexpansion" let-product>
        <tr>
            <td colspan="7">
                <div class="p-0">
                    <p-table [value]="product.Accounts" dataKey="id">
                        <ng-template pTemplate="header">
        <tr>
            <th width="65%">Account Name</th>
            <th width="12.5%" class="text-right">Planned</th>
            <th width="12.5%" class="text-right">Actual</th>
            <th width="12.5%" class="text-right">Provisional</th>
            <th width="10%"></th>
        </tr>
    </ng-template>
    <ng-template pTemplate="body" let-order let-expa="expanded">
        <tr>
            <td>{{ order.AccountName }}</td>
            <td class="text-right">{{ order.Planned | currency }} USD</td>
            <td class="text-right">{{ order.Paid | currency }} USD</td>
            <td class="text-right">{{ order.Provisional | currency }} MXN</td>
            <td>
                <button type="button" pButton pRipple [pRowToggler]="order"
                    class="p-button-text p-button-rounded p-button-plain"
                    [icon]="expa ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></button>
            </td>
        </tr>
    </ng-template>
    <ng-template pTemplate="rowexpansion" let-subaccount>
        <tr>
            <td colspan="5">
                <div class="p-0">
                    <p-table [value]="subaccount.subAccounts">
                        <ng-template pTemplate="header">
        <tr>
            <th width="25%">Activity Name</th>
            <th width="25%">Sub Account Name</th>
            <th width="12.5%">RP</th>
            <th width="12.5%" class="text-right">Planned</th>
            <th width="12.5%" class="text-right">Actual</th>
            <th width="12.5%" class="text-right">Provisional</th>
            <th width="10%" class="text-center">Actions</th>
        </tr>
    </ng-template>
    <ng-template pTemplate="body" let-data let-expanded="expanded">
        <tr>
            <td>{{data.Name}}</td>
            <td>{{data.account || data.accountWA}}</td>
            <td>{{data.idrpnumber ? 'RP' + data.idrpnumber : ' '}}</td>
            <td class="text-right">{{data.planned | currency}} USD</td>
            <td class="text-right">{{data.paid | currency}} USD</td>
            <td class="text-right">{{data.provisional | currency}} MXN</td>
            <td class="text-center">
                <button *ngIf="data.paid > 0 && rpSelected.length <= 1" type="button" pButton pRipple icon="pi pi-search"
                    class="p-button-rounded p-button-text p-button-sm" (click)="openSubAccountModal(data, subaccount.AccountName)"
                    pTooltip="Ver detalles de transacciones" tooltipPosition="top">
                </button>
            </td>
        </tr>
    </ng-template>
    <ng-template pTemplate="emptymessage">
        <tr>
            <td colspan="7">There are no subaccounts avaiable.</td>
        </tr>
    </ng-template>
</p-table>
</div>
</td>
</tr>
</ng-template>
<ng-template pTemplate="emptymessage">
    <tr>
        <td colspan="5">There are no summary in this activity.</td>
    </tr>
</ng-template>
</p-table>
</div>
</td>
</tr>
</ng-template>
<ng-template pTemplate="emptymessage">
    <tr>
        <td colspan="6">There are no data avaiable.</td>
    </tr>
</ng-template>
<ng-template pTemplate="footer">
    <tr>
        <td width="40%" class="text-right">Total</td>
        <td width="12.5%" class="text-right">{{totalsFinancial.totalApproved | currency}} USD</td>
        <td width="12.5%" class="text-right">{{totalsFinancial.totalAssembly | currency}} USD</td>
        <td width="12.5%" class="text-right">{{totalsFinancial.totalPlanned | currency}} USD</td>
        <td width="12.5%" class="text-right">{{totalsFinancial.totalPaid | currency}} USD</td>
        <td width="12.5%" class="text-right">{{totalsFinancial.totalProvisional | currency}} MXN</td>
    </tr>
</ng-template>
</p-table>


<p-dialog header="New Actual Expenses" [(visible)]="showSubAccountModal" [modal]="true" [maximizable]="true"
    [draggable]="false" [resizable]="true" >

    <div *ngIf="selectedSubAccount" class="revision-content">

        <div class="grid info-sub">
            <div class="col-1">
                <small>Type</small>
                <p class="font-bold">{{selectedSubAccount.type || 'N/A'}}</p>
            </div>
            <div class="col-1">
                <small>RP</small>
                <p class="font-bold">{{selectedSubAccount.idrpnumber ? + selectedSubAccount.idrpnumber : '01'}}</p>
            </div>
            <div class="col">
                <small>Account</small>
                <p class="font-bold">{{selectedSubAccount.parentAccountName || 'N/A'}}</p>
            </div>
            <div class="col">
                <small>Subaccount</small>
                <p class="font-bold">{{selectedSubAccount.account || selectedSubAccount.accountWA}}</p>

            </div>
            <!--
            <div class="col">
                <small>Total Current </small>
                <p class="font-bold">{{selectedSubAccount.paid | currency}} USD</p>
            </div>
            -->
            <div class="col">
                <small>Total transactions</small>
                <p class="font-bold">{{transactionList.length}}</p>
            </div>
        </div>
        <hr>
        <div class="grid">

            <div class="col-4">
                <p> <span class="font-bold">Step 1:</span> Select the ones to be reassigned to an RP, sub-account, or
                    both. The ones you don't select will not be sent for review.</p>

                <p-table [value]="transactionList" [rowsPerPageOptions]="[10, 25, 50]"
                    [paginator]="true" [rows]="10" syleClass="p-datatable-sm">
                    <ng-template pTemplate="header">
                        <tr>
                            <th>
                                <p-checkbox 
                                    [(ngModel)]="selectAllTransactions"
                                    [binary]="true"
                                    (onChange)="toggleAllTransactions()"
                                    pTooltip="Select all transactions"
                                    tooltipPosition="top">
                                </p-checkbox>
                            </th>
                            <th>Transaction ID</th>
                            <th>Payment date</th>
                            <th class="text-right">Amount</th>
                        </tr>
                    </ng-template>

                    <ng-template pTemplate="body" let-transaction>
                        <tr [ngClass]="{'p-highlight': transaction.selected}">
                            <td>
                                <p-checkbox 
                                    [(ngModel)]="transaction.selected" 
                                    [binary]="true"
                                    (onChange)="updateSelectedTotal()">
                                </p-checkbox>
                            </td>
                            <td>
                                <p>{{transaction.id}}</p>
                            </td>
                            <td>
                                <p>{{transaction.paymentDate}}</p>
                            </td>
                            <td class="text-right">
                                <p>{{transaction.amount}}</p>
                            </td>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="footer">
                        <tr *ngIf="!hasSelectedTransactions()">
                            <td colspan="3" class="text-right font-bold">TOTAL</td>
                            <td class="text-right font-bold">${{totalGeneral.toFixed(2)}}</td>
                        </tr>
                        
                        <tr *ngIf="hasSelectedTransactions()">
                            <td colspan="3" class="text-right font-bold">TOTAL SELECTED</td>
                            <td class="text-right font-bold">${{totalSelected.toFixed(2)}}</td>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="emptymessage">
                        <tr>
                            <td colspan="4" class="text-center">
                                <p class="p-3">No transactions available</p>
                            </td>
                        </tr>
                    </ng-template>
                </p-table>
            </div>

            <div class="col-8">
                <p><span class="font-bold">Step 2:</span> Make the reassignment</p>
                <div class="grid">
                    <div class="col">
                        <small>Selected transactions</small>

                        <p class="font-bold">{{getSelectedTransactionsCount()}} transaction{{getSelectedTransactionsCount() !== 1 ? 's' : ''}}</p>
                    </div>
                    <div class="col">
                        <span class="p-float-label">
                            <p-dropdown 
                                id="new-rp" 
                                [options]="rpOptions" 
                                [(ngModel)]="newRP" 
                                (onChange)="onRPSelected()"
                                optionLabel="label"
                                optionValue="value" 
                                placeholder="Select RP" 
                                inputId="rp-dropdown">
                            </p-dropdown>
                        </span>
                    </div>
                    <div class="col">
                        <span class="p-float-label">
                        <p-dropdown 
                            [(ngModel)]="newSubAccount"
                            [options]="currentSubAccountOptions" 
                            [disabled]="currentSubAccountOptions.length === 0"
                            placeholder="Select SubAccount" 
                            optionLabel="displayName"
                            optionValue="uniqueId"
                            [filter]="true"
                            [showClear]="true"
                            inputId="subaccount-dropdown"
                            appendTo="body">
                        </p-dropdown>
                            <label for="subaccount-dropdown">
                                Subaccount
                            </label>
                        </span>
                    </div>
                </div>
                
                <hr>
                <div class="grid">
                    <div class="col-12">
                        <p><span class="font-bold">Step 3:</span> Provide a strong justification to prevent your request
                            from being rejected.</p>
                        <span class="p-float-label">
                            <textarea 
                                id="justification" 
                                pInputTextarea 
                                [(ngModel)]="justification" 
                                [rows]="6"
                                [autoResize]="true" 
                                class="w-full">
                            </textarea>
                            <label for="justification">Justification</label>
                        </span>
                    </div>
                    <p>The finance department and the technical director will review your request in detail.</p>
                </div>
            </div>
        </div>
    </div>

    <ng-template pTemplate="footer">
        <p-button label="Cancel" styleClass="p-button-outlined" (click)="closeRevisionModal()"></p-button>
        <p-button label="Send" (click)="sendRevisionRequest()"></p-button>
    </ng-template>
</p-dialog>
<p-toast></p-toast>